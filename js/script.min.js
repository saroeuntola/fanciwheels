const phoneInput=document.querySelector("#phone"),phoneInput1=document.querySelector("#phone1"),iti=window.intlTelInput(phoneInput,{initialCountry:"bd",preferredCountries:["bd","in","vn","cn"],separateDialCode:!0,utilsScript:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.2.1/js/utils.js"}),iti1=window.intlTelInput(phoneInput1,{initialCountry:"bd",preferredCountries:["bd","in","vn","cn"],separateDialCode:!0,utilsScript:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.2.1/js/utils.js"});document.querySelector("#registerForm").addEventListener("submit",async e=>{e.preventDefault(),phoneInput.value=iti.getNumber();const t=new FormData(e.target),n=t.get("name").trim(),i=t.get("gmail").trim(),a=t.get("phone").trim();if(n&&i)try{const e=await fetch("https://fanciwheel.com/admin/page/api/create_player",{method:"POST",body:new URLSearchParams({name:n,gmail:i,phone:a}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}),t=await e.json();t.success?Swal.fire({icon:"success",title:`Welcome, ${t.player.name}!`,text:"Registration successful."}).then(()=>{window.open("spin.php")}):Swal.fire({icon:"error",title:"Registration Failed",text:t.message||"Failed to register."})}catch(e){Swal.fire({icon:"error",title:"Server Error",text:"An error occurred during registration."}),console.error(e)}else Swal.fire({icon:"warning",title:"Missing Information",text:"Please fill in Name and Gmail."})}),document.querySelector("#registerForm1").addEventListener("submit",async e=>{e.preventDefault(),phoneInput1.value=iti1.getNumber();const t=new FormData(e.target),n=t.get("name").trim(),i=t.get("gmail").trim(),a=t.get("phone1").trim();if(n&&i)try{const e=await fetch("https://fanciwheel.com/admin/page/api/create_player",{method:"POST",body:new URLSearchParams({name:n,gmail:i,phone1:a}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}),t=await e.json();t.success?Swal.fire({icon:"success",title:`Welcome, ${t.player.name}!`,text:"Registration successful."}).then(()=>{window.open("spin.php")}):Swal.fire({icon:"error",title:"Registration Failed",text:t.message||"Failed to register."})}catch(e){Swal.fire({icon:"error",title:"Server Error",text:"An error occurred during registration."}),console.error(e)}else Swal.fire({icon:"warning",title:"Missing Information",text:"Please fill in Name and Gmail."})});const wheel=document.getElementById("wheel"),spinBtn=document.getElementById("spinBtn"),popupOverlay=$("#popupOverlay"),popupOverlay1=$("#popupOverlay1"),popupMessage=$("#popupMessage"),closePopup=$("#closePopup"),closePopup1=$("#closePopup1"),closeModalBtn=document.getElementById("closeModalBtn"),segmentNumbers=["Red","yallow","Blue","Yallow","blue","yallow","red","Yallow","blue","yallow","blue","yallow","red","Yallow","blue","yallow"],segments=segmentNumbers.length,segmentAngle=360/segments;let startTimestamp=null,duration=8e3,startRotation=0,targetRotation=0,animationFrameId=null,winningIndex=0;const lang="<?= $lang ?>",translations={en:{freeSpin:"Free Spin",winMessage:"🎉 You won"},bn:{freeSpin:"ফ্রি স্পিন",winMessage:"🎉 আপনি জিতেছেন"}};let spinCount=0;const maxSpins=1,spinCountDisplay=document.getElementById("spinCountDisplay");function updateSpinCountDisplay(){const e=`${translations[lang].freeSpin}: ${spinCount}/1`;spinCountDisplay.textContent=e,spinCountDisplay.classList.add("spin-count")}function easeOutQuart(e){return 1-Math.pow(1-e,4)}function animate(e){startTimestamp||(startTimestamp=e);let t=(e-startTimestamp)/duration;t>1&&(t=1);const n=easeOutQuart(t),i=startRotation+n*(targetRotation-startRotation);wheel.style.transform=`rotate(${i}deg)`,t<1?animationFrameId=requestAnimationFrame(animate):performWobble(i)}function performWobble(e){const t=[-5,4,-3,2,-1,1,-.5,0];let n=0;!function i(){if(n>=t.length){spinBtn.disabled=!1;const n=((e+t[t.length-1])%360+segmentAngle/2)%360;winningIndex=Math.floor(n/segmentAngle),winningIndex=(segments-winningIndex%segments)%segments;const i=segmentNumbers[winningIndex];return popupMessage.text(`${translations[lang].winMessage} ${i}!`),void popupOverlay.hide().css("display","flex").hide().slideDown(400)}const a=e+t[n];wheel.style.transition="transform 0.3s ease-in-out",wheel.style.transform=`rotate(${a}deg)`,n++,setTimeout(i,200)}()}function getCurrentRotation(){const e=window.getComputedStyle(wheel).getPropertyValue("transform");if("none"===e)return 0;const t=e.match(/matrix\(([^)]+)\)/)[1].split(", "),n=parseFloat(t[0]),i=parseFloat(t[1]);let a=Math.round(Math.atan2(i,n)*(180/Math.PI));return a<0?a+360:a}spinBtn.addEventListener("click",()=>{if(spinBtn.disabled)return;if(spinCount>=1)return popupOverlay1.hide().css("display","flex").hide().slideDown(400),void(spinBtn.disabled=!0);spinCount++,updateSpinCountDisplay(),spinBtn.disabled=!0,cancelAnimationFrame(animationFrameId),startTimestamp=null,startRotation=getCurrentRotation();winningIndex=Math.floor(Math.random()*segments),targetRotation=startRotation+1440+winningIndex*segmentAngle,wheel.style.transition="none",animationFrameId=requestAnimationFrame(animate)}),closePopup.on("click",()=>{popupOverlay.slideUp(400)}),closePopup1.on("click",()=>{popupOverlay1.slideUp(400)}),closeModalBtn.addEventListener("click",()=>{document.getElementById("spinWheelModal").style.display="none"}),window.addEventListener("load",()=>{document.getElementById("spinWheelModal").style.display="flex",wheel.style.transform="rotate(0deg)",updateSpinCountDisplay()});